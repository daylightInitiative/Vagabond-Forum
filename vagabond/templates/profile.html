{% extends "base.html" %}

{% block content %}

    {% if userinfo %}
        <img style="width: 200px; height: 200px;" class="center-image" src="/static/avatars/{{ userinfo.avatar_hash or '/static/img/not_found.png' }}.jpg">
        <p>Hello, <b>{{ userinfo.username }}</b>! You are user number: {{ userinfo.userid }}<br>Welcome! We appreciate your patronage since {{ userinfo.join_date }}</p>
        {% if is_superuser %}
            <p>As an <b>admin</b>! be sure to use your power to make everyone happy! <b>or else..</b></p>
        {% endif %}
    {% endif %}

    {% if sessions %}
        <button id="sign-out-sessions">Sign out of all other sessions</button>
        <p style="display:none;" id="status-text"></p>

        <h2>Login Sessions</h2>
        {% for sesh in sessions %}
            <b>Status: {{ 'ACTIVE' if sesh.active else 'INACTIVE' }}</b>
            <p>Session from: {{ sesh.userAgent }} by IP address {{ sesh.ipaddr }} on {{ sesh.lastLogin }}</p>
        {% endfor %}

        <script>
            const signout = document.getElementById("sign-out-sessions");
            const status = document.getElementById("status-text");
            
            function delay(time) {
                return new Promise(resolve => setTimeout(resolve, time));
            }

            async function display_status_msg(element, text) {
                element.style.display = 'block';
                element.innerHTML = text;
                await delay(3000);
                element.style.display = 'none';
                element.innerHTML = "";
            }

            async function sign_out_of_all_other_sessions() {
                try {

                    const response = await fetch('/invalidate_other_sessions', {
                        method: "POST",
                        body: JSON.stringify({
                        }),
                        headers: {
                            "Content-type": "application/json; charset=UTF-8"
                        }
                    })

                    if (!response.ok) {
                        display_status_msg(status, "Error: There was an error signing out other sessions");
                        throw new Error(`Reponse status: ${response.status}`);
                    }

                    // create our new interval
                    display_status_msg(status, "Successfully signed out other sessions");
                } catch (error) {
                    console.log(error);
                }
            }

            signout.onclick = function() {
                console.log("signing out of all other sessions...");
                sign_out_of_all_other_sessions();
            };
        </script>
    {% endif %}

{% endblock %}